Этап 3
===

До оптимизаций
---

### Результаты нагрузочного тестирования

Во всех тестах время подачи нагрузки составляло 1 минуту.

1. PUT 2/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148451

    Установлено, что предел пропускной способности - на уровне 5000 rps.

        Средняя задержка: 0.82 мс
        90-%ная квантиль: 1.27 мс
        99-%ная квантиль: 5.10 мс

    Постоянная нагрузка 5000 rps -
    https://overload.yandex.net/148453

        Средняя задержка: 0.86 мс
        90-%ная квантиль: 1.39 мс
        99-%ная квантиль: 4.95 мс

2. PUT 3/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148458

    Пропускная способность осталась на том же уровне.

        Средняя задержка: 0.82 мс
        90-%ная квантиль: 1.43 мс
        99-%ная квантиль: 4.95 мс

    Постоянная нагрузка 5000 rps -
    https://overload.yandex.net/148460

        Средняя задержка: 0.86 мс
        90-%ная квантиль: 1.34 мс
        99-%ная квантиль: 4.89 мс

3. GET 2/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148462

    Установлено, что предел пропускной способности - на уровне 7500 rps.

        Средняя задержка: 0.53 мс
        90-%ная квантиль: 0.76 мс
        99-%ная квантиль: 3.49 мс

    Постоянная нагрузка 7500 rps -
    https://overload.yandex.net/148465

        Средняя задержка: 0.60 мс
        90-%ная квантиль: 0.98 мс
        99-%ная квантиль: 3.36 мс

4. GET 3/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148468

    Установлено, что предел пропускной способности - на уровне 7500 rps.

        Средняя задержка: 0.54 мс
        90-%ная квантиль: 0.87 мс
        99-%ная квантиль: 3.41 мс

    Постоянная нагрузка 7500 rps -
    https://overload.yandex.net/148469

        Средняя задержка: 0.60 мс
        90-%ная квантиль: 0.97 мс
        99-%ная квантиль: 3.24 мс


5. PUT+GET 2/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148471

    Установлено, что предел пропускной способности - на уровне 6000 rps.

        Средняя задержка: 0.65 мс
        90-%ная квантиль: 1.26 мс
        99-%ная квантиль: 3.15 мс

    Небольшая часть GET-запросов (0.32%) завершились с кодом 404, т.к. ключи, по которым выполнялась
    операция GET еще не были добавлены на момент выполнения этих запросов.

    Постоянная нагрузка 6000 rps -
    https://overload.yandex.net/148472

        Средняя задержка: 0.66 мс
        90-%ная квантиль: 1.03 мс
        99-%ная квантиль: 3.11 мс

6. PUT+GET 3/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148473

    Установлено, что предел пропускной способности - на уровне 6000 rps.

        Средняя задержка: 0.62 мс
        90-%ная квантиль: 1.02 мс
        99-%ная квантиль: 3.07 мс

    Постоянная нагрузка 6000 rps -
    https://overload.yandex.net/148474

        Средняя задержка: 0.68 мс
        90-%ная квантиль: 1.11 мс
        99-%ная квантиль: 3.23 мс

Отсутствие сколько-нибудь значительной разницы между запросами с replication factor (RF) 2/3 и 3/3 объясняется тем,
в обоих случаях запросы делаются ко всем 3 узлам кластера, но в одном случае считается, что для успешной операции
достаточно двух подтверждений от трех узлов, а во втором - трёх. Если бы один из узлов был недоступен, то для
RF=2/3 запрос хоть и с задержкой, но выполнялся бы успешно, а для RF=3/3 была бы ошибка Not Enough Replicas.

Фактор задержки при текущей реализации приложения сводит на нет преимущества RF=2/3 в плане быстродействия,
потому что узел, принявший запрос от пользователя, всегда ждёт ответа от всех from-узлов вне зависимости от ack,
и когда все ответы либо таймауты получены, собирает ответ для пользователя, исходя из значения ack и количества
подтверждений операции от узлов. И если, например, одна нода тормозит, то даже если запрос пользователя был бы
удовлетворен и без её ответа, ему всё равно придётся ждать, пока она пришлёт этот ответ. В этом плане виден
путь для оптимизации: как только требуемое количество ack собрано, можно "забить" на обращения к репликам,
которые еще в процессе, и сразу отвечать пользователю.

Для иллюстрации этой проблемы можно искусственно замедлить одну ноду, например, на 5 мс, и увидеть, что результаты
для RF=2/3 и RF=3/3 примерно одинаковые, хотя в половине случаев (когда хэш-код ключа на попадает на тормозящую 
ноду) можно было бы ожидать гораздо более быстрого ответа при RF=2/3.

7. GET 2/3, один узел кластера замедлен

    Постоянная нагрузка 1000 rps -
    https://overload.yandex.net/148486

        Средняя задержка: 21 мс
        90-%ная квантиль: 32 мс
        99-%ная квантиль: 38 мс

8. GET 3/3, один узел кластера замедлен

    Постоянная нагрузка 1000 rps -
    https://overload.yandex.net/148487

        Средняя задержка: 21 мс
        90-%ная квантиль: 32 мс
        99-%ная квантиль: 37 мс

### Результаты профилирования

Для профилирования использовался [async-profiler](https://github.com/jvm-profiling-tools/async-profiler), запускаемый со следующими флагами:
```
-d 45 # профилировать в течение 45 секунд
-i 500us # интервал профилирования 500 мкс (чтобы в среднем попадать в каждый запрос - минимальная средняя задержка была равна 0.53 мс)
-f result.svg --minwidth 0.5 --width 2000 # настройки для Flame Graph
```

Результат в эксперименте PUT+GET 3/3:

[![FlameGraph before optimizations](imgs/profile_before.svg)](imgs/profile_before.svg)

Можно заметить, что как при чтении, так и при записи значительную часть процессорного времени занимает вызов 
H2Bridge.contains(), от которого вполне можно отказаться в случае c GET, так как при отсутствии запрошенного ключа 
база данных возвращает пустой набор результатов, и проверки на пустоту достаточно, чтобы обнаружить отсутствие данных.

Кроме того, в процессе экспериментов (например, https://overload.yandex.net/148561) было установлено, что в программе
есть bottleneck в виде single thread executor в классе Replica - после его замены на cached thread pool появилась
возможность выполнять HTTP-запросы к *каждой* реплике в несколько потоков, что дало существеннный прирост к 
производительности (см. далее).

После оптимизаций
---

После выполнения описанных выше оптимизаций наиболее интересно рассмотреть изменения для случаев 7-8:

7. GET 2/3, один узел кластера замедлен

    Постоянная нагрузка 1000 rps -
    https://overload.yandex.net/148567

        Средняя задержка: 0.22 мс -> в ~95 раз лучше
        90-%ная квантиль: 0.26 мс -> в ~123 раза лучше
        99-%ная квантиль: 1.33 мс -> в ~29 раз лучше

    Задержки очень сильно упали по сравнению с тем, что было до оптимизации, что подтверждает правильность предложенных 
    решений и их реализации.

8. GET 3/3, один узел кластера замедлен

    Постоянная нагрузка 1000 rps -
    https://overload.yandex.net/148569

        Средняя задержка: 7.14 мс -> в ~2.9 раза лучше
        90-%ная квантиль: 11.0 мс -> в ~2.9 раза лучше
        99-%ная квантиль: 15.0 мс -> в ~2.5 раза лучше

    Даже несмотря на необходимость ожидать ответа от замедленного узла, сделанные оптимизации позволили уменьшить
    задержки в несколько раз, и теперь разница между RF 2/3 и 3/3 играет существенную роль при "тормозящих" нодах,
    позволяя получать результаты быстрее при отказе от некоторой доли консистентности.


Далее представлены результаты нагрузочного тестирования для остальных случаев:

1. PUT 2/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148590

    Установлено, что предел пропускной способности - на уровне 6300 rps.

        Средняя задержка: 0.61 мс
        90-%ная квантиль: 0.95 мс
        99-%ная квантиль: 4.08 мс

    Постоянная нагрузка 5000 rps -
    https://overload.yandex.net/148606

        Средняя задержка: 0.85 мс
        90-%ная квантиль: 1.33 мс
        99-%ная квантиль: 6.30 мс

2. PUT 3/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148620

    Предел пропускной способности - на уровне 5000 rps.

        Средняя задержка: 0.80 мс
        90-%ная квантиль: 1.38 мс
        99-%ная квантиль: 4.75 мс

    Постоянная нагрузка 5000 rps -
    https://overload.yandex.net/148622

        Средняя задержка: 0.84 мс
        90-%ная квантиль: 1.38 мс
        99-%ная квантиль: 4.99 мс

3. GET 2/3

    Линейно возрастающая нагрузка от 0 до 20000 rps -
    https://overload.yandex.net/148636

    Установлено, что предел пропускной способности - на уровне 12000 rps.

        Средняя задержка: 0.31 мс
        90-%ная квантиль: 0.43 мс
        99-%ная квантиль: 1.85 мс

    Постоянная нагрузка 7500 rps -
    https://overload.yandex.net/148644

        Средняя задержка: 0.31 мс
        90-%ная квантиль: 0.45 мс
        99-%ная квантиль: 1.89 мс

    Постоянная нагрузка 12000 rps - 
    https://overload.yandex.net/148672

        Средняя задержка: 0.35 мс
        90-%ная квантиль: 0.50 мс
        99-%ная квантиль: 2.30 мс

4. GET 3/3

    Линейно возрастающая нагрузка от 0 до 15000 rps -
    https://overload.yandex.net/148653

    Установлено, что предел пропускной способности - на уровне 11000 rps.

        Средняя задержка: 0.35 мс
        90-%ная квантиль: 0.50 мс
        99-%ная квантиль: 2.36 мс

    Постоянная нагрузка 7500 rps -
    https://overload.yandex.net/148658

        Средняя задержка: 0.33 мс
        90-%ная квантиль: 0.47 мс
        99-%ная квантиль: 2.11 мс

    Постоянная нагрузка 11000 rps -
    https://overload.yandex.net/148675

        Средняя задержка: 0.40 мс
        90-%ная квантиль: 0.52 мс
        99-%ная квантиль: 2.42 мс


5. PUT+GET 2/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148668

    Установлено, что предел пропускной способности - на уровне 7300 rps.

        Средняя задержка: 0.53 мс
        90-%ная квантиль: 0.80 мс
        99-%ная квантиль: 3.54 мс

    Постоянная нагрузка 6000 rps -
    https://overload.yandex.net/148669    

        Средняя задержка: 0.47 мс
        90-%ная квантиль: 0.75 мс
        99-%ная квантиль: 3.17 мс

6. PUT+GET 3/3

    Линейно возрастающая нагрузка от 0 до 10000 rps -
    https://overload.yandex.net/148670

    Установлено, что предел пропускной способности - на уровне 7000 rps.

        Средняя задержка: 0.52 мс
        90-%ная квантиль: 0.75 мс
        99-%ная квантиль: 3.51 мс

    Постоянная нагрузка 6000 rps -
    https://overload.yandex.net/148672

        Средняя задержка: 0.56 мс
        90-%ная квантиль: 0.83 мс
        99-%ная квантиль: 3.65 мс

